apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: chains-image
spec:
  type: image
  params:
    - name: url
      value: 34.68.185.37:5000/chains-image
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-docker-image-from-git-source
spec:
  resources:
    outputs:
      - name: builtImage
        type: image
  results:
    - name: IMAGE_URL
      description: the image url of the output image
    - name: IMAGE_DIGEST
      description: the image digest of the output image
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.6.0
      command:
        - /kaniko/executor
      args:
        - --dockerfile=/dockerfile/Dockerfile
        - --destination=$(resources.outputs.builtImage.url)
        - --context=/dockerfile
        - --cache=false
        - --digest-file=$(results.IMAGE_DIGEST.path)
        - --insecure-registry=34.68.185.37:5000
        - --insecure
        - --insecure-pull
      volumeMounts: 
      - name: dockerfile
        mountPath: /dockerfile
    - name: image-url
      image: bash:latest
      script: |
        #!/usr/bin/env bash
        echo $(resources.outputs.builtImage.url) | tee $(results.IMAGE_URL.path)
      volumeMounts: 
      - name: dockerfile
        mountPath: /dockerfile
  volumes:
  - name: dockerfile
    configMap:
      name: dockerfile
      items:
        - key: "Dockerfile"
          path: "Dockerfile"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dockerfile
data:
  # file-like keys
  Dockerfile: |
    FROM alpine@sha256:69e70a79f2d41ab5d637de98c1e0b055206ba40a8145e7bddb55ccc04e13cf8f
